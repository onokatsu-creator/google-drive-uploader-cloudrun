<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画像アップロードフォーム</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        /* (CSS部分は変更ありません) */
        html, body { font-size: 16px; margin: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Segoe UI", "Hiragino Kaku Gothic ProN", "ヒラギノ角ゴ ProN W3", Arial, "メイリオ", Meiryo, sans-serif; background-color: #f4f7f6; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; position: relative; }
        .work-header { text-align: center; margin-bottom: 2rem; padding: 1rem; background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        #work-icon { font-size: 3rem; color: #007bff; margin-bottom: 0.5rem; }
        #work-title { font-size: 1.8rem; margin: 0; color: #333; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; font-size: 1.1rem; font-weight: bold; margin-bottom: 0.5rem; }
        input, textarea, select { width: 100%; padding: 15px; font-size: 1.2rem; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; -webkit-appearance: none; appearance: none; }
        input[type="file"] { padding: 10px; }
        input[readonly] { background-color: #e9ecef; color: #495057; }
        button { width: 100%; padding: 15px; font-size: 1.3rem; font-weight: bold; color: white; background-color: #007bff; border: none; border-radius: 8px; cursor: pointer; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.7); color: white; display: flex; justify-content: center; align-items: center; text-align: center; z-index: 10; }
        .worker-display { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 15px; font-size: 1.2rem; }
        .data-reg-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .data-reg-button { padding: 20px 10px; font-size: 1rem; font-weight: bold; background-color: #e9ecef; color: #495057; border: 1px solid #ced4da; border-radius: 8px; cursor: pointer; text-align: center; }
        .data-reg-button.active { background-color: #007bff; color: white; border-color: #007bff; }
        .data-reg-form { margin-top: 1.5rem; padding: 20px; border: 1px solid #dee2e6; border-radius: 8px; background: #fff; }
        #confirm-modal, #next-action-modal { display: none; position: fixed; z-index: 20; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); }
        .modal-content { background-color: #fefefe; margin: 25% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; }
        #confirm-details { text-align: left; margin-bottom: 20px; word-wrap: break-word; }
        #confirm-details p { margin: 8px 0; font-size: 1.1rem; }
        .confirm-photo-container img { max-width: 100%; max-height: 200px; border-radius: 4px; margin-top: 10px;}
        .modal-buttons { display: flex; flex-direction: column; justify-content: space-between; gap: 10px; }
        .modal-buttons button { width: 100%; }
        #confirm-no { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-overlay" style="display: none;"><p>はじめに、あなたの<br>NFCカードをかざして<br>認証してください</p></div>
        <h1>画像アップロード</h1>
        <div class="work-header">
            <span id="work-icon"></span>
            <h2 id="work-title"></h2>
        </div>
        <form id="kintoneForm" enctype="multipart/form-data">
            <div class="form-group"><label for="placeID">場所ID:</label><input type="text" id="placeID" name="placeID" readonly></div>
            <div class="form-group"><label for="houseID">ハウスID:</label><input type="text" id="houseID" name="houseID" readonly></div>
            <div class="form-group"><label for="treiID">トレイID:</label><input type="text" id="treiID" name="treiID" readonly></div>
            <div class="form-group"><label>作業者:</label><div id="worker-name-display" class="worker-display">未ログイン</div><input type="hidden" id="username" name="username"><input type="hidden" id="worker_id" name="worker_id"></div>
            <hr style="margin: 2rem 0;">

            <div class="dynamic-field" id="work_area_ocr" style="display: none;">
                <p>アップロードする画像の種類を選択してください。</p>
                <!-- ★★★ 修正箇所①：「今日」ボタンを追加し、3列表示にする ★★★ -->
                <div class="data-reg-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <button type="button" class="data-reg-button" data-target="form_npk_test">NPK</button>
                    <button type="button" class="data-reg-button" data-target="form_today">今日</button>
                    <button type="button" class="data-reg-button" data-target="form_habitat_image">生息画像</button>
                </div>
                <div id="data-reg-forms-container">
                    <div id="form_npk_test" class="data-reg-form" style="display: none;">
                        <label for="photo_npk_test_type">土壌検査の写真を添付:</label>
                        <input type="file" name="photo_npk_test_type" accept="image/*">
                    </div>

                    <!-- ★★★ 修正箇所②：「今日」用のフォームを追加 ★★★ -->
                    <div id="form_today" class="data-reg-form" style="display: none;">
                        <label for="photo_today">今日の記録写真を添付:</label>
                        <input type="file" name="photo_today" accept="image/*">
                    </div>

                    <div id="form_habitat_image" class="data-reg-form" style="display: none;">
                        <label for="habitat_image">生息画像を添付:</label>
                        <input type="file" name="habitat_image" accept="image/*">
                    </div>
                </div>
            </div>

            <hr style="border: none; border-top: 2px solid #eee; margin: 2rem 0;">
            <div class="form-group"><label for="memo">メモ:</label><textarea id="memo" name="memo" rows="4"></textarea></div>

            <button type="submit">アップロード実行</button>
        </form>
    </div>

    <div id="confirm-modal"><div class="modal-content"><h2>入力内容の確認</h2><div id="confirm-details"></div><div class="modal-buttons" style="flex-direction: row;"><button type="button" id="confirm-no">いいえ、修正する</button><button type="button" id="confirm-yes">はい、送信する</button></div></div></div>
    <div id="next-action-modal"><div class="modal-content"><h2>登録しました！</h2><p>次の操作を選択してください。</p><div class="modal-buttons"><button type="button" id="choice-continue">続けて同じトレイを入力する</button><button type="button" id="choice-new-work" style="background-color: #6c757d;">新たな作業をする</button></div></div></div>

    <script>
        const workConfigs = {
            'ocr': { title: '画像登録', icon: '<i class="fas fa-camera-retro"></i>' },
            'water': { title: '水槽の記録', icon: '<i class="fas fa-tint"></i>' }
        };

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const placeID = urlParams.get('placeID');
            const houseID = urlParams.get('houseID');
            const treiID = urlParams.get('treiID');
            const workID = urlParams.get('workID');

            if (placeID) document.getElementById('placeID').value = placeID;
            if (houseID) document.getElementById('houseID').value = houseID;
            if (treiID) document.getElementById('treiID').value = treiID;

            updateUIByWorkID(workID);
            checkLoginStatus();
        };

        function updateUIByWorkID(workID) {
            const iconEl = document.getElementById('work-icon');
            const titleEl = document.getElementById('work-title');
            document.querySelectorAll('.dynamic-field').forEach(field => field.style.display = 'none');

            const config = workConfigs[workID];
            if (config) {
                iconEl.innerHTML = config.icon;
                titleEl.textContent = config.title;
                if (workID === 'ocr') {
                    document.getElementById('work_area_ocr').style.display = 'block';
                    setupDataRegistrationMenu();
                }
            } else {
                iconEl.innerHTML = '<i class="fas fa-hand-pointer"></i>';
                titleEl.textContent = '新たな作業のNFCをかざしてください';
            }
        }

        function checkLoginStatus() {
            const savedId = localStorage.getItem('savedWorkerId');
            const savedName = localStorage.getItem('savedWorkerName');
            const savedDate = localStorage.getItem('savedLoginDate');
            const today = new Date();
            const todayString = `${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;

            if (savedId && savedName && savedDate === todayString) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('worker-name-display').textContent = savedName;
                document.getElementById('username').value = savedName;
                document.getElementById('worker_id').value = savedId;
                document.querySelector('button[type="submit"]').disabled = false;
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.querySelector('button[type="submit"]').disabled = true;
            }
        }

        function setupDataRegistrationMenu() {
            const buttons = document.querySelectorAll('.data-reg-button');
            const forms = document.querySelectorAll('.data-reg-form');
            // ★★★ 修正箇所③-1：「今日」の入力欄への参照を追加 ★★★
            const npkInput = document.querySelector('input[name="photo_npk_test_type"]');
            const todayInput = document.querySelector('input[name="photo_today"]');
            const habitatInput = document.querySelector('input[name="habitat_image"]');
            
            if(buttons.length === 0 || forms.length === 0) return;

            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    if (this.classList.contains('active')) {
                        return;
                    }
                    
                    // ★★★ 修正箇所③-2：ファイル選択のチェック/リセット処理を修正 ★★★
                    const isFileSelected = npkInput.files.length > 0 || habitatInput.files.length > 0 || todayInput.files.length > 0;
                    
                    if (isFileSelected) {
                        const confirmResult = confirm("選択できる画像は1種類だけです。\n現在選択している写真はクリアされますが、よろしいですか？");
                        
                        if (!confirmResult) {
                            return; 
                        }
                        
                        npkInput.value = '';
                        habitatInput.value = '';
                        todayInput.value = '';
                    }
                    
                    buttons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    forms.forEach(form => form.style.display = 'none');
                    const targetId = this.getAttribute('data-target');
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                });
            });
        }

        document.getElementById('kintoneForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);
            const activeFormId = document.querySelector('.data-reg-button.active')?.getAttribute('data-target');

            // ★★★ 修正箇所③-3：送信処理の分岐を修正 ★★★
            if (!activeFormId) {
                alert('「NPK」「今日」「生息画像」のいずれかを選択してください。');
                return;
            }

            let detailsHtml = '';
            let imageToShow = null;

            if (activeFormId === 'form_npk_test') {
                imageToShow = formData.get('photo_npk_test_type');
                if (imageToShow && imageToShow.size > 0) {
                     detailsHtml += `<div class="confirm-photo-container"><p><strong>NPK(土壌検査)の写真:</strong></p><img id="confirm-img-preview"></div>`;
                }
            } else if (activeFormId === 'form_today') {
                imageToShow = formData.get('photo_today');
                if (imageToShow && imageToShow.size > 0) {
                    detailsHtml += `<div class="confirm-photo-container"><p><strong>今日の記録写真:</strong></p><img id="confirm-img-preview"></div>`;
                }
            } else if (activeFormId === 'form_habitat_image') {
                imageToShow = formData.get('habitat_image');
                 if (imageToShow && imageToShow.size > 0) {
                     detailsHtml += `<div class="confirm-photo-container"><p><strong>生息画像の写真:</strong></p><img id="confirm-img-preview"></div>`;
                }
            }

            const memo = formData.get('memo');
            if (memo) detailsHtml += `<p><strong>メモ:</strong> ${memo}</p>`;

            if (!imageToShow || imageToShow.size === 0) {
                alert('記録する画像が選択されていません。');
                return;
            }

            document.getElementById('confirm-details').innerHTML = detailsHtml;
            if (imageToShow) {
                const imgPreview = document.getElementById('confirm-img-preview');
                if(imgPreview) imgPreview.src = URL.createObjectURL(imageToShow);
            }
            document.getElementById('confirm-modal').style.display = 'block';
        });

        document.getElementById('confirm-yes').addEventListener('click', function() {
            const form = document.getElementById('kintoneForm');
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const activeFormId = document.querySelector('.data-reg-button.active')?.getAttribute('data-target');

            // ★★★ 修正箇所③-3：送信処理の分岐を修正 ★★★
            let fetchUrl;
            let body = new FormData(); 

            body.append('placeID', formData.get('placeID'));
            body.append('houseID', formData.get('houseID'));
            body.append('treiID', formData.get('treiID'));
            body.append('username', formData.get('username'));
            body.append('worker_id', formData.get('worker_id'));
            body.append('memo', formData.get('memo'));

            if (activeFormId === 'form_npk_test') {
                fetchUrl = '/submit';
                body.append('photo_npk_test_type', formData.get('photo_npk_test_type'));
            } else if (activeFormId === 'form_today') {
                fetchUrl = '/submit_today';
                body.append('photo_today', formData.get('photo_today')); 
            } else if (activeFormId === 'form_habitat_image') {
                fetchUrl = '/upload_habitat_image';
                body.append('habitat_image', formData.get('habitat_image')); 
            } else {
                alert('処理の種類が選択されていません。');
                return;
            }

            document.getElementById('confirm-modal').style.display = 'none';
            submitButton.disabled = true;
            submitButton.textContent = '送信中...';

            fetch(fetchUrl, { method: 'POST', body: body })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('next-action-modal').style.display = 'block';
                } else {
                    alert('エラー: ' + result.message);
                }
            })
            .catch(error => {
                console.error('送信エラー:', error);
                alert('送信中に予期せぬエラーが発生しました。');
            })
            .finally(() => {
                submitButton.disabled = false;
                submitButton.textContent = 'アップロード実行';
            });
        });

        document.getElementById('confirm-no').addEventListener('click', function() { document.getElementById('confirm-modal').style.display = 'none'; });

        document.getElementById('choice-continue').addEventListener('click', function() {
             const form = document.getElementById('kintoneForm');
             // ★★★ 修正箇所③-3：リセット対象に 'photo_today' を追加 ★★★
             const fieldsToReset = ['photo_npk_test_type', 'habitat_image', 'photo_today', 'memo'];
             fieldsToReset.forEach(name => {
                const field = form.querySelector(`[name="${name}"]`);
                if(field) field.value = '';
            });
            document.querySelectorAll('.data-reg-button.active').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.data-reg-form').forEach(frm => frm.style.display = 'none');
            document.getElementById('next-action-modal').style.display = 'none';
        });

        document.getElementById('choice-new-work').addEventListener('click', function() { window.location.href = '/'; });
    </script>
</body>
</html>